# EMS-ESP flash tool

Warning! This is for initial installs only. The Flash, the NVS and all its content will NOT be erased.

(c) proddy

## Fist time setup

- install the GitHub CLI (gh command) (<https://github.com/cli/cli/blob/trunk/docs/install_linux.md>). On an Apple Mac you can use `brew install gh`. The first time you'll need to authenticate with `gh auth login`.
- install the latest version of Python (<https://www.python.org/downloads/>)
- install pip (<https://realpython.com/what-is-pip/#using-pip-in-a-python-virtual-environment>)
- install the python libraries: `pip install -r requirements.txt`
- install `minicom` using `apt-get install minicom` on WSL2 or Linux. This is a simple terminal program to connect to the serial port of the device so we can Telnet to EMS-ESP and check if its working.
- make sure all the shell scripts are executable: `chmod +x *.sh`. Those are firmware/firmware.sh, upload/E32V2/upload.sh and upload/S3/upload.sh.
- optional for Windows/WSL: install `udbisp` to access the Windows COM ports. `winget install usbipd`. See <https://github.com/dorssel/usbipd-win>.

## Setting up

If you're running Python in a virtual environment, you need to activate it first:

- `python3 -m venv venv` to create the virtual environment
- `source ./venv/bin/activate` to enter it
- `pip install -r requirements.txt` to install the libraries

Important! Run all shell commands from the root directory of this project. If you can't access them, check the permissions and run `chmod +x *.sh` to make them executable.

## Step 1 - Building and Preparing

Run:

```sh
./firmware/firmware.sh
```

to fetch the latest EMS-ESP stable & development firmware binaries from the GitHub release page. They are placed in the `firmware` folder. Note, you will need to have the GitHub CLI is installed for this to work. See above.

## Step 2 - Uploading to the ESP32 device

Run the command using this syntax:

 ```sh
./upload/<board>/upload.sh [<port> | auto] [dev]
 ```

`<board>` is S3 or E32V2,
`<port>` is /dev/ttyUSB0, /dev/ttyACM0 or auto
`dev` is an optional parameter, indicating to install the latest dev fimrware version

 As an example, this will use the latest development firmware for an E32 V2 Gateway and the first COM port found:

 ```sh
./upload/E32V2/upload.sh auto dev
 ```

 or

 ```sh
 ./upload/S3/upload.sh auto dev
 ```

After a successful upload, it will try and connect to the EMS-ESP via the USB/serial port and output the board profile. Make sure you verify this. If nothing is shown then perhaps the USB doesn't support Serial/UART. You can manually check this using `minicom -D <port>`.

(Note: if you're using WSL2, use `usbipd list` from a DOS/PowerShell admin window to show all the available COM ports and then connect to one using a command like `usbipd attach -a -w -b 2-3` (after first binding it with for example `usbipd bind --busid 2-3`). Check on the Linux WSL2 whether you now have a USB port in `/dev` like `/dev/ttyUSB0` or `ttyACM0`.)

## Partition explanation (techie bit)

The partitions for the two Gateway boards are based on the 16MB variant using the partition table `esp32_partition_16M.csv`. The structure is:

3.6.5 :

| Name       | Type       | SubType  | Offset        | Size               | Notes                           | File                            |
|------------|------------|----------|---------------|--------------------|---------------------------------|---------------------------------|
| bootloader |            |          | 0x0000/0x1000 | 0x8000   (32 KB)   | ESP32-S3=0x1000, ESP32=0x1000   | bootloader*.bin                 |
| partitions |            |          | 0x8000        | 0x1000   (4 KB)    | same for each board             | partitions*.bin                 |
| -           |            |          |               |                    |                                 |                                 |
| nvs        | data       | nvs      | 0x9000        | 0x5000   (20 KB)   | reserved for ESP32              |                                 |
| otadata    | data       | ota      | 0xE000        | 0x2000   (8 KB)    | same for each board             | boot_app0*.bin                  |
| boot       | app        | factory  | 0x10000       | 0x280000 (2.5 MB)  | default boot partition          | EMS-ESP firmware *.bin/loader   |
| app0       | app        | ota_0    | 0x290000      | 0x590000 (5.56 MB) | OTA cycle 1                     | EMS-ESP firmware *.bin          |
| app1       | app        | ota_1    | 0x510000      | 0x590000 (5.56 MB) | OTA cycle 2                     | EMS-ESP firmware *.bin          |
| nvs1       | data       | nvs      | 0xAA0000      | 0x040000 (256 KB)  | custom for EMS-ESP              | (generated by script)           |
| spiffs     | data       | spiffs   | 0xAA0000      | 0x200000 (2 MB)    | for LittleFS/EMS-ESP filesystem | (not used)                      |
| coredump   | data       | coredump | 0xCE0000      | 0x010000 (64 KB)   |                                 |                                 |

3.7.0 :

| Name       | Type       | SubType  | Offset        | Size               | Notes                           | File                            |
|------------|------------|----------|---------------|--------------------|---------------------------------|---------------------------------|
| bootloader |            |          | 0x0000/0x1000 | 0x8000   (32 KB)   | ESP32-S3=0x1000, ESP32=0x1000   | bootloader*.bin                 |
| partitions |            |          | 0x8000        | 0x1000   (4 KB)    | same for each board             | partitions*.bin                 |
| -          |            |          |               |                    |                                 |                                 |
| nvs        | data       | nvs      | 0x9000        | 0x5000   (20 KB)   | reserved for ESP32              |                                 |
| otadata    | data       | ota      | 0xE000        | 0x2000   (8 KB)    | same for each board             | boot_app0*.bin                  |
| boot       | app        | factory  | 0x10000       | 0x480000 (4.5 MB)  | default boot partition          | EMS-ESP firmware *.bin/loader   |
| app0       | app        | ota_0    | 0x290000      | 0x490000 (4.56 MB) | OTA cycle 1                     | EMS-ESP firmware *.bin          |
| app1       | app        | ota_1    | 0x510000      | 0x490000 (4.56 MB) | OTA cycle 2                     | EMS-ESP firmware *.bin          |
| nvs1       | data       | nvs      | 0xAA0000      | 0x040000 (256 KB)  | custom for EMS-ESP              | (generated by script)           |
| spiffs     | data       | spiffs   | 0xAA0000      | 0x200000 (2 MB)    | for LittleFS/EMS-ESP filesystem | (not used)                      |
| coredump   | data       | coredump | 0xCE0000      | 0x010000 (64 KB)   |                                 |                                 |

- Reference: <https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/partition-tables.html>
- There are 3 places where the EMS-ESP firmware is stored:
  - `boot` is the default used on fresh installs.
  - `app0` and `app1` are the firmware partitions used during OTA updates, and cycles between the two. The firmware is loaded into one of these non-active partitions, and then the device is rebooted.
- The bootloader (called second stage) is the `bootloader_dio_80m.bin` executable and is used to read the partition table at offset 0x8000 and determine which partitions are available. Note the bootloader's offset is different per chip type. ESP32 is [0x1000](https://docs.espressif.com/projects/esp-idf/en/stable/esp32/api-guides/bootloader.html#bootloader) and ESP32-S3 is [0x0000](https://docs.espressif.com/projects/esp-idf/en/stable/esp32s3/api-guides/bootloader.html#bootloader). This is handled in our script `upload.sh` for each Model type in the parameter `bootloader_address`.
- The partition `otadata` is used to hold a small application used to determine which partition (boot, app0, app1) to use. It will query the data stored in `partitions` block.
- EMS-ESP can be restarted to other partitions using the command `restart <boot|app0|app1>`.
- The EMS-ESP Console/API command `show system` will show the current partition and the partition that will be booted after a restart.
- With all the board/chip types, the `boot_app0.bin` and `partitions.bin` are the same file for each board. Only the `bootloader.bin` is different. But we keep local copies to keep things tidy in a single folder.
